# Implementation Plan: Models Multi-Select for Create API Key

**Branch**: `001-models-multiselect` | **Date**: 2026-02-24 | **Spec**: [specs/001-models-multiselect/spec.md](./spec.md)  
**Input**: Feature specification from `/specs/001-models-multiselect/spec.md`

---

## Summary

Replace the free-text comma-separated "Models" input field in the **Create API Key** form (and the **Edit Key Settings** form) with a structured multi-select that presents all currently configured proxy models as selectable checkboxes, plus a prominent "All Models" option. No DB schema changes, no new API endpoints â€” the change is contained to the UI layer (`internal/ui/`).

---

## Technical Context

**Language/Version**: Go 1.26 (module `github.com/praxisllmlab/tianjiLLM`)  
**Primary Dependencies**: `a-h/templ` (server-side HTML components), HTMX (partial page updates), templUI component library (existing â€” `internal/ui/components/`)  
**Storage**: PostgreSQL via sqlc â€” `VerificationToken.models text[]` column already exists; **no schema change**  
**Testing**: `go test` + `testify`; contract tests in `test/contract/` (`ui_test.go`, `key_management_test.go`)  
**Target Platform**: Linux server (web UI served at `/ui/`)  
**Performance Goals**: Page render â‰¤ 200ms p95 (no change from current baseline; model list â‰¤ 100 items)  
**Constraints**: No external JS dependencies; inline `<script>` for toggle logic only; templ files must be regenerated via `templ generate` after edit  
**Scale/Scope**: Single-page UI change affecting 2 templ files and 1 handler file

---

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Python-First Reference | âœ… PASS | Models selector is a UI feature unique to the Go UI â€” no Python TianjiLLM UI equivalent. The underlying `allowed_models` semantics (empty = unrestricted) match Python behavior. |
| II. Feature Parity | âœ… PASS | The API key's `models` field semantics are unchanged. External API contracts are unaffected. |
| III. Research Before Build | âœ… PASS | Research completed; see `research.md`. All decisions backed by codebase review. |
| IV. Test-Driven Migration | âœ… PASS | Existing `test/contract/ui_test.go` and `test/contract/key_management_test.go` provide test coverage points. New unit tests for `loadKeysPageData` (model list loading) are required. |
| V. Go Best Practices | âœ… PASS | No new abstractions beyond what's needed. No nesting > 3 levels. Error handling via standard `error` returns. |
| VI. No Stale Knowledge | âœ… PASS | All design decisions derived from codebase inspection, not agent memory. |
| VII. sqlc-First DB Access | âœ… PASS | Uses existing `ListProxyModels` sqlc query. **No hand-written SQL.** No new queries needed. |

**Post-Phase 1 Re-check**: All principles still hold. Design uses existing sqlc queries and adds no DB layer code.

---

## Project Structure

### Documentation (this feature)

```text
specs/001-models-multiselect/
â”œâ”€â”€ plan.md              â† This file
â”œâ”€â”€ spec.md              â† Feature specification
â”œâ”€â”€ research.md          â† Phase 0 output (complete)
â”œâ”€â”€ data-model.md        â† Phase 1 output (complete)
â”œâ”€â”€ quickstart.md        â† Phase 1 output (complete)
â””â”€â”€ tasks.md             â† Phase 2 output (created by /speckit.tasks â€” NOT this command)
```

### Source Code Changes

```text
internal/ui/
â”œâ”€â”€ handler_keys.go          â† MODIFY: loadKeysPageData, handleKeyCreate, handleKeyUpdate
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ keys.templ           â† MODIFY: KeysPageData struct, createKeyForm template
â”‚   â”œâ”€â”€ keys_templ.go        â† REGENERATED by `templ generate`
â”‚   â”œâ”€â”€ key_detail.templ     â† MODIFY: KeyDetailData struct, edit settings form
â”‚   â””â”€â”€ key_detail_templ.go  â† REGENERATED by `templ generate`
â””â”€â”€ (no new files required)

test/
â””â”€â”€ contract/
    â”œâ”€â”€ ui_test.go             â† EXTEND: add multi-select rendering assertions
    â””â”€â”€ key_management_test.go â† EXTEND: add create-key-with-models test cases
```

**Structure Decision**: Single-project Go server. UI-only change; no new packages or files needed. The existing `internal/ui/` package handles all modifications in-place.

---

## Phase 0: Research â€” Complete

All unknowns resolved. See [`research.md`](./research.md) for full decision log.

**Key decisions:**
1. Custom inline checkbox-inside-popover/details pattern (no new shared component)
2. Model name source: `ListProxyModels` (DB) + `Config.ModelList` (YAML), deduplicated
3. Form encoding: repeated `name="models"` checkboxes + `all_models` sentinel hidden field
4. Scope: both Create and Edit forms updated
5. Backend: `r.Form["models"]` replaces `parseCSV(r.FormValue("models"))`

---

## Phase 1: Design â€” Complete

Artifacts: [`data-model.md`](./data-model.md), [`quickstart.md`](./quickstart.md)

---

## Detailed Implementation Plan

### Step 1 â€” `pages.KeysPageData`: Add `AvailableModels`

**File**: `internal/ui/pages/keys.templ`

```go
type KeysPageData struct {
    // ... all existing fields unchanged ...

    // AvailableModels is the list of model names configured in the proxy.
    // Used to populate the Models multi-select in the Create Key form.
    // Empty slice means no models are configured; "All Models" is always shown.
    AvailableModels []string
}
```

---

### Step 2 â€” `handler_keys.go`: Populate `AvailableModels` in `loadKeysPageData`

**File**: `internal/ui/handler_keys.go`

Add after loading teams/users (before building filter params):

```go
// Load available model names for the models selector.
data.AvailableModels = h.loadAvailableModelNames(r.Context())
```

New helper (private, in `handler_keys.go`):

```go
// loadAvailableModelNames returns deduplicated model names from DB + YAML config.
// Follows the same merge logic as loadModelsPageData in handler_models.go.
func (h *UIHandler) loadAvailableModelNames(ctx context.Context) []string {
    seen := map[string]struct{}{}
    var names []string

    // DB models (authoritative source when DB is available).
    if h.DB != nil {
        rows, err := h.DB.ListProxyModels(ctx)
        if err == nil {
            for _, m := range rows {
                if _, ok := seen[m.ModelName]; !ok {
                    seen[m.ModelName] = struct{}{}
                    names = append(names, m.ModelName)
                }
            }
        }
    }

    // YAML config models (fill in any not already in DB list).
    if h.Config != nil {
        for _, m := range h.Config.ModelList {
            if _, ok := seen[m.ModelName]; !ok {
                seen[m.ModelName] = struct{}{}
                names = append(names, m.ModelName)
            }
        }
    }

    return names
}
```

---

### Step 3 â€” `handler_keys.go`: Fix `handleKeyCreate` Form Parsing

**File**: `internal/ui/handler_keys.go`

Replace:
```go
modelsStr := r.FormValue("models")
// ...
models := parseCSV(modelsStr)
```

With:
```go
allModels := r.FormValue("all_models") // "1" = All Models selected
var models []string
if allModels != "1" {
    models = r.Form["models"] // repeated form values from checkboxes
    // nil/empty slice â†’ no restriction (treated as All Models per spec FR-008)
}
```

---

### Step 4 â€” `handler_keys.go`: Fix `handleKeyUpdate` Form Parsing

**File**: `internal/ui/handler_keys.go`

In `handleKeyUpdate`, replace:
```go
modelsStr := r.FormValue("models")
// ...
if modelsStr != "" {
    params.Models = parseCSV(modelsStr)
}
```

With:
```go
allModels := r.FormValue("all_models")
if allModels == "1" {
    params.Models = []string{} // explicitly unrestricted
} else {
    selectedModels := r.Form["models"]
    if selectedModels != nil {
        params.Models = selectedModels
    }
}
```

Also: `handleKeyUpdate` needs `AvailableModels` in the error-path re-render.
Load it when building `data` for error responses:
```go
data.AvailableModels = h.loadAvailableModelNames(r.Context())
```

---

### Step 5 â€” `keys.templ`: Replace Free-Text Models Input with Multi-Select

**File**: `internal/ui/pages/keys.templ`

In `createKeyForm`, replace the models `<div class="space-y-2">` block:

**Remove**:
```templ
<div class="space-y-2">
    <label for="models" class="text-sm font-medium">Models (comma-separated)</label>
    @input.Input(input.Props{
        ID: "models", Name: "models",
        Placeholder: "gpt-4, claude-sonnet-4-5-20250929",
    })
</div>
```

**Replace with**:
```templ
<div class="space-y-2">
    <label class="text-sm font-medium">Models</label>
    @modelsMultiSelect("create", data.AvailableModels, []string{})
</div>
```

Add new helper template:

```templ
// modelsMultiSelect renders a checkbox-based multi-select for model selection.
// formPrefix is used to namespace IDs ("create" or "edit").
// available is the list of all model names from the proxy.
// selected is the list of currently selected model names (for edit form pre-fill).
templ modelsMultiSelect(formPrefix string, available []string, selected []string) {
    // Build a lookup set for pre-selected models.
    {{ selectedSet := make(map[string]bool, len(selected)) }}
    for _, s := range selected {
        {{ selectedSet[s] = true }}
    }
    {{ allModelsChecked := len(selected) == 0 }}

    <input type="hidden" name="all_models" id={ formPrefix + "-all-models-hidden" }
        if allModelsChecked {
            value="1"
        } else {
            value="0"
        }
    />

    <details class="rounded-md border border-input bg-background">
        <summary class="flex cursor-pointer select-none items-center justify-between px-3 py-2 text-sm">
            <span id={ formPrefix + "-models-summary" }>
                if allModelsChecked || len(available) == 0 {
                    All Models
                } else {
                    { fmt.Sprintf("%d model(s) selected", len(selected)) }
                }
            </span>
            @icon.ChevronDown(icon.Props{Size: 16, Class: "text-muted-foreground"})
        </summary>
        <div class="border-t border-input px-3 py-2 space-y-1 max-h-48 overflow-y-auto">
            <!-- All Models option -->
            <label class="flex items-center gap-2 text-sm cursor-pointer py-0.5">
                <input
                    type="checkbox"
                    id={ formPrefix + "-model-all" }
                    class="h-4 w-4 rounded border-input"
                    if allModelsChecked || len(available) == 0 {
                        checked
                    }
                    onchange={ toggleAllModels(formPrefix) }
                />
                <span class="font-medium">All Models</span>
            </label>
            if len(available) > 0 {
                <div class="border-t border-input my-1"></div>
                for _, m := range available {
                    <label class="flex items-center gap-2 text-sm cursor-pointer py-0.5">
                        <input
                            type="checkbox"
                            name="models"
                            value={ m }
                            class={ formPrefix + "-model-checkbox h-4 w-4 rounded border-input" }
                            if selectedSet[m] {
                                checked
                            }
                            if allModelsChecked {
                                disabled
                            }
                            onchange={ updateModelsSummary(formPrefix) }
                        />
                        <span class="font-mono text-xs">{ m }</span>
                    </label>
                }
            }
        </div>
    </details>
}

script toggleAllModels(formPrefix string) {
    var allCheckbox = document.getElementById(formPrefix + '-model-all');
    var hidden = document.getElementById(formPrefix + '-all-models-hidden');
    var individualBoxes = document.querySelectorAll('.' + formPrefix + '-model-checkbox');
    if (allCheckbox.checked) {
        hidden.value = '1';
        individualBoxes.forEach(function(cb) { cb.checked = false; cb.disabled = true; });
        document.getElementById(formPrefix + '-models-summary').textContent = 'All Models';
    } else {
        hidden.value = '0';
        individualBoxes.forEach(function(cb) { cb.disabled = false; });
        updateModelsSummary(formPrefix);
    }
}

script updateModelsSummary(formPrefix string) {
    var allCheckbox = document.getElementById(formPrefix + '-model-all');
    if (allCheckbox.checked) { return; }
    var hidden = document.getElementById(formPrefix + '-all-models-hidden');
    var checked = document.querySelectorAll('.' + formPrefix + '-model-checkbox + span, .' + formPrefix + '-model-checkbox:checked');
    var count = document.querySelectorAll('.' + formPrefix + '-model-checkbox:checked').length;
    hidden.value = '0';
    var summary = document.getElementById(formPrefix + '-models-summary');
    if (count === 0) {
        hidden.value = '1';
        allCheckbox.checked = true;
        summary.textContent = 'All Models';
    } else {
        summary.textContent = count + ' model(s) selected';
    }
}
```

> **Note**: The `templ` compiler handles `script` blocks as typed JS functions callable from template attributes. This is the existing project pattern (see `copyToClipboard` in `keys.templ`).

---

### Step 6 â€” `key_detail.templ`: Add `AvailableModels` and Replace Edit Form Input

**File**: `internal/ui/pages/key_detail.templ`

1. Add `AvailableModels []string` to `KeyDetailData` struct.

2. In the edit settings form (within `EditSettingsForm` or the models input section), replace the `models` text input with `@modelsMultiSelect(...)`.

   Since `modelsMultiSelect` is defined in `keys.templ` (same package `pages`), it is directly callable from `key_detail.templ`.

   ```templ
   // In the edit form models section:
   <div class="space-y-2">
       <label class="text-sm font-medium">Models</label>
       @modelsMultiSelect("edit", data.AvailableModels, data.Models)
   </div>
   ```

---

### Step 7 â€” `handler_keys.go`: Populate `AvailableModels` for Key Detail Handlers

**File**: `internal/ui/handler_keys.go`

In `handleKeyDetail`, `handleKeyEdit`, `handleKeyUpdate` (success and error paths):

```go
data.AvailableModels = h.loadAvailableModelNames(r.Context())
```

---

### Step 8 â€” `templ generate`

After all `.templ` file edits:

```bash
templ generate
go build ./...
```

---

### Step 9 â€” Tests

**New unit test** in `internal/ui/` (or `handler_keys_test.go`):

```go
func TestLoadAvailableModelNames(t *testing.T) {
    // Test: DB models + config models are merged, deduplicated
    // Test: DB nil â†’ falls back to config only
    // Test: empty config + empty DB â†’ returns []string{}
}
```

**Extend contract tests** (`test/contract/key_management_test.go`):

```go
// TestCreateKeyWithSpecificModels:
//   POST /ui/keys/create with all_models=0&models=gpt-4&models=claude-3
//   Verify key row shows "gpt-4, claude-3"
//   Verify DB VerificationToken.Models == ["gpt-4", "claude-3"]

// TestCreateKeyWithAllModels:
//   POST /ui/keys/create with all_models=1
//   Verify key row shows "All Models" badge
//   Verify DB VerificationToken.Models == []

// TestCreateKeyNoModelCheckbox:
//   POST /ui/keys/create with all_models=0 and no models= values
//   Verify treated as All Models (empty slice)
```

---

## Complexity Tracking

No constitution violations. No complexity justification required.

---

## Phase Artifacts Summary

| Artifact | Path | Status |
|----------|------|--------|
| `research.md` | `specs/001-models-multiselect/research.md` | âœ… Complete |
| `data-model.md` | `specs/001-models-multiselect/data-model.md` | âœ… Complete |
| `quickstart.md` | `specs/001-models-multiselect/quickstart.md` | âœ… Complete |
| `plan.md` | `specs/001-models-multiselect/plan.md` | âœ… This file |
| `tasks.md` | `specs/001-models-multiselect/tasks.md` | â³ Next: `/speckit.tasks` |

---

## Implementation Checklist (pre-tasks)

- [ ] `pages.KeysPageData` struct: add `AvailableModels []string`
- [ ] `pages.KeyDetailData` struct: add `AvailableModels []string`
- [ ] `handler_keys.go`: add `loadAvailableModelNames` helper
- [ ] `handler_keys.go`: call `loadAvailableModelNames` in `loadKeysPageData`
- [ ] `handler_keys.go`: call `loadAvailableModelNames` in key detail handlers
- [ ] `handler_keys.go`: fix `handleKeyCreate` form parsing (all_models + r.Form["models"])
- [ ] `handler_keys.go`: fix `handleKeyUpdate` form parsing (all_models + r.Form["models"])
- [ ] `keys.templ`: add `modelsMultiSelect` template + JS scripts
- [ ] `keys.templ`: replace free-text models input in `createKeyForm`
- [ ] `key_detail.templ`: replace free-text models input in edit settings form
- [ ] Run `templ generate`
- [ ] Run `go build ./...`
- [ ] Write/extend unit tests for `loadAvailableModelNames`
- [ ] Write/extend contract tests for create-key with models
- [ ] Manual verification against quickstart checklist

---

## E2E Testing Plan

### Testing Tool

The project uses **Playwright** for E2E testing (see `Makefile` â€” `make e2e`). All new E2E tests should follow the same runner setup.

### Test File Path

```
e2e/key_models_multiselect_test.ts
```

### Setup / Teardown

Each test (or `describe` block) should:

1. **Setup**: Authenticate as an admin user; ensure at least 2 configured proxy models exist in the DB/config.
2. **Teardown**: Delete any API keys created during the test via the UI or a direct DB cleanup helper.

```ts
// Pseudocode
test.beforeEach(async ({ page }) => {
  await loginAsAdmin(page);
  await ensureModelsExist(page, ['gpt-4', 'claude-3']);
});

test.afterEach(async ({ page }) => {
  await deleteAllTestKeys(page); // cleans up keys with test-prefixed names
});
```

### Test Scenarios

#### Scenario 1 â€” Create API Key dialog shows Models multi-select with all configured models

```ts
test('Create API Key dialog renders Models multi-select with all configured models', async ({ page }) => {
  await page.goto('/ui/keys');
  await page.getByRole('button', { name: /create api key/i }).click();
  const dialog = page.getByRole('dialog');
  await expect(dialog.getByText('Models')).toBeVisible();
  // Expand the dropdown
  await dialog.locator('details summary').click();
  // All configured models must appear as checkboxes
  await expect(dialog.getByLabel('All Models')).toBeChecked();
  await expect(dialog.getByLabel('gpt-4')).toBeVisible();
  await expect(dialog.getByLabel('claude-3')).toBeVisible();
});
```

#### Scenario 2 â€” Select a single model â†’ Create key â†’ Confirm DB stores only that model

```ts
test('Creating key with one model selected stores only that model in DB', async ({ page }) => {
  await page.goto('/ui/keys');
  await page.getByRole('button', { name: /create api key/i }).click();
  const dialog = page.getByRole('dialog');
  // Expand dropdown and deselect All Models, select gpt-4 only
  await dialog.locator('details summary').click();
  await dialog.getByLabel('All Models').uncheck(); // triggers auto-enable of individuals
  await dialog.getByLabel('gpt-4').check();
  // Fill other required fields and submit
  await dialog.getByLabel('Key Name').fill('test-single-model');
  await dialog.getByRole('button', { name: /create/i }).click();
  // Verify the key row shows "gpt-4"
  await expect(page.getByText('gpt-4')).toBeVisible();
  // DB assertion (via API or UI detail page)
  await page.getByText('test-single-model').click();
  await expect(page.getByTestId('key-models')).toHaveText('gpt-4');
});
```

#### Scenario 3 â€” Select multiple models â†’ Create key â†’ Confirm all are stored

```ts
test('Creating key with multiple models stores all selected models', async ({ page }) => {
  await page.goto('/ui/keys');
  await page.getByRole('button', { name: /create api key/i }).click();
  const dialog = page.getByRole('dialog');
  await dialog.locator('details summary').click();
  await dialog.getByLabel('All Models').uncheck();
  await dialog.getByLabel('gpt-4').check();
  await dialog.getByLabel('claude-3').check();
  await dialog.getByLabel('Key Name').fill('test-multi-model');
  await dialog.getByRole('button', { name: /create/i }).click();
  // Verify summary shows "2 model(s) selected"
  await expect(page.getByText('test-multi-model')).toBeVisible();
  await page.getByText('test-multi-model').click();
  await expect(page.getByTestId('key-models')).toContainText('gpt-4');
  await expect(page.getByTestId('key-models')).toContainText('claude-3');
});
```

#### Scenario 4 â€” Select "All Models" â†’ Create key â†’ Confirm DB models is empty array

```ts
test('Creating key with All Models selected stores empty array in DB', async ({ page }) => {
  await page.goto('/ui/keys');
  await page.getByRole('button', { name: /create api key/i }).click();
  const dialog = page.getByRole('dialog');
  // All Models is pre-checked by default â€” just submit
  await dialog.getByLabel('Key Name').fill('test-all-models');
  await dialog.getByRole('button', { name: /create/i }).click();
  await page.getByText('test-all-models').click();
  // Key detail should show "All Models (unrestricted)"
  await expect(page.getByTestId('key-models')).toHaveText(/all models/i);
});
```

#### Scenario 5 â€” Default (no model selection) â†’ Equivalent to "All Models"

```ts
test('Submitting without changing model selection defaults to All Models', async ({ page }) => {
  // Identical to Scenario 4 â€” "All Models" is the default checked state.
  // This test validates the initial form state without any interaction.
  await page.goto('/ui/keys');
  await page.getByRole('button', { name: /create api key/i }).click();
  const dialog = page.getByRole('dialog');
  // Verify "All Models" is checked without any user interaction
  await dialog.locator('details summary').click();
  await expect(dialog.getByLabel('All Models')).toBeChecked();
  // Individual model checkboxes should be disabled when All Models is selected
  const firstModelCheckbox = dialog.locator('.model-checkbox').first();
  await expect(firstModelCheckbox).toBeDisabled();
});
```

#### Scenario 6 â€” Edit key settings â†’ Change model selection â†’ Save â†’ Confirm update

```ts
test('Editing key model selection updates DB correctly', async ({ page }) => {
  // Pre-condition: a key named "test-edit-models" exists with All Models
  await createTestKey(page, 'test-edit-models', []);
  await page.goto('/ui/keys');
  await page.getByText('test-edit-models').click();
  // Open edit settings
  await page.getByRole('button', { name: /edit settings/i }).click();
  // Expand model dropdown, deselect All Models, pick specific model
  await page.locator('details summary').click();
  await page.getByLabel('All Models').uncheck();
  await page.getByLabel('gpt-4').check();
  await page.getByRole('button', { name: /save/i }).click();
  // Confirm update reflected in detail view
  await expect(page.getByTestId('key-models')).toHaveText('gpt-4');
});
```

---

## UI/UX Design

### Component Choice

Use a **custom `<details>` + checkbox list** pattern â€” consistent with the existing Go/templ/HTMX stack, zero new dependencies.

- A `<details>`/`<summary>` element acts as the popover toggle.
- Checkboxes inside render the selectable model list.
- A small inline `<script>` (templ `script` block) handles state sync (summary text, disabled states, hidden sentinel).

> Alternative: templUI `Checkbox` + `Popover` components if they expose the required APIs. Prefer the custom pattern for full control over disabled/sentinel logic without overriding component internals.

---

### Visual Design Specification

| State | Summary Label | Individual Checkboxes |
|-------|---------------|-----------------------|
| Default / "All Models" selected | `All Models (unrestricted)` (muted/gray) | All **disabled** |
| N specific models selected | `N model(s) selected` | Enabled; selected ones checked |
| No model checked (transient) | Auto-reverts to "All Models" | â€” |

**Trigger (closed state)**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  All Models (unrestricted)        â–¾ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Trigger â€” N models selected**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2 model(s) selected              â–¾ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Search input** (shown when `len(availableModels) > 10`):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” Filter models...                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ASCII Wireframe

#### Dropdown â€” Closed

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Models                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚  All Models (unrestricted)      â–¾ â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Dropdown â€” Open (â‰¤ 10 models, "All Models" selected)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Models                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚  All Models (unrestricted)      â–´ â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ â˜‘  All Models          (bold)     â”‚   â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚ â”‚ â˜  gpt-4               (disabled) â”‚   â”‚
â”‚ â”‚ â˜  claude-3             (disabled) â”‚   â”‚
â”‚ â”‚ â˜  gemini-pro           (disabled) â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Dropdown â€” Open (specific models selected)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Models                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚  2 model(s) selected            â–´ â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ â˜  All Models                     â”‚   â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚ â”‚ â˜‘  gpt-4                          â”‚   â”‚
â”‚ â”‚ â˜‘  claude-3                       â”‚   â”‚
â”‚ â”‚ â˜  gemini-pro                     â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Dropdown â€” Open (> 10 models, with search)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Models                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚  All Models (unrestricted)      â–´ â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ ğŸ” Filter models...               â”‚   â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚ â”‚ â˜‘  All Models          (bold)     â”‚   â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚ â”‚ â˜  gpt-4               (disabled) â”‚   â”‚
â”‚ â”‚ â˜  gpt-4o              (disabled) â”‚   â”‚
â”‚ â”‚ â˜  claude-3             (disabled) â”‚   â”‚
â”‚ â”‚ â˜  ...                            â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Interaction Behavior

| Trigger | Action |
|---------|--------|
| Page load / form open | "All Models" is checked; all individual checkboxes disabled |
| User checks any specific model | "All Models" auto-unchecks; individual checkboxes enabled |
| User unchecks last specific model | "All Models" auto-re-checks; individual checkboxes disabled |
| User checks "All Models" | All individual checkboxes uncheck and disable; summary resets |
| User unchecks "All Models" (without selecting model) | Individual checkboxes enable; summary shows "0 model(s) selected" â†’ on blur/submit treated as All Models |

---

### Accessibility Requirements

| Requirement | Implementation |
|-------------|----------------|
| Keyboard navigation | `<details>`/`<summary>` is natively keyboard-accessible (Enter/Space to toggle) |
| Tab order | Checkboxes inside the open `<details>` receive natural tab focus |
| `aria-label` on summary | `aria-label="Select models for this API key"` |
| `aria-label` on "All Models" checkbox | `aria-label="All Models (unrestricted)"` |
| `aria-label` per model checkbox | `aria-label="Model: {model_name}"` |
| Disabled state announcement | `disabled` attribute ensures screen readers announce "dimmed/unavailable" |
| Search input (if shown) | `aria-label="Filter models"`, `role="searchbox"`, live-filters list via JS |
| Summary label updates | `aria-live="polite"` on the summary `<span>` so screen readers announce changes |

```templ
<summary aria-label="Select models for this API key" class="...">
    <span id={ formPrefix + "-models-summary" } aria-live="polite">
        All Models (unrestricted)
    </span>
    @icon.ChevronDown(...)
</summary>
```
