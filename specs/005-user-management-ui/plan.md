# Implementation Plan: User Management UI

**Branch**: `feat/user-management-ui`
**Date**: 2026-02-27
**Spec**: `specs/005-user-management-ui/spec.md`
**Linear**: HO-19

## Summary

Add User Management UI pages to tianjiLLM, following the existing Teams/Orgs pattern.
Users page at `/users` with list, detail, create, edit, disable/enable, delete.

## Technical Context

**Language**: Go 1.24 + Templ + HTMX
**Pattern**: Follow `handler_teams.go` + `teams.templ` exactly
**DB**: `UserTable` already exists, `user.sql` queries already exist
**No migration needed**: Status stored in `metadata` JSONB

## Files to Create/Modify

### New Files (6)
| File | Description |
|------|-------------|
| `internal/ui/handler_users.go` | List page + create + table partial + block/unblock/delete |
| `internal/ui/handler_users_detail.go` | Detail page + edit + update |
| `internal/ui/handler_users_test.go` | Unit tests |
| `internal/ui/pages/users.templ` | Templ templates (list + detail + dialogs) |
| `internal/db/queries/user.sql` | Add: ListUsersPaginated, SearchUsers, CountUsers, SoftDeleteUser |
| `internal/db/user.sql.go` | Regenerated by sqlc |
| `test/e2e/users_*.go` | E2E tests (list, create, edit, delete) |

### Modified Files (2)
| File | Change |
|------|--------|
| `internal/ui/routes.go` | Add `/users` routes |
| `internal/ui/pages/layout.templ` | Add "Users" to sidebar nav |

## DB Query Changes

Need to add to `internal/db/queries/user.sql`:

```sql
-- name: ListUsersPaginated :many
SELECT * FROM "UserTable"
WHERE ($1::text = '' OR user_alias ILIKE '%' || $1 || '%' OR user_email ILIKE '%' || $1 || '%')
  AND ($2::text = '' OR user_role = $2)
ORDER BY created_at DESC
LIMIT $3 OFFSET $4;

-- name: CountUsers :one
SELECT COUNT(*) FROM "UserTable"
WHERE ($1::text = '' OR user_alias ILIKE '%' || $1 || '%' OR user_email ILIKE '%' || $1 || '%')
  AND ($2::text = '' OR user_role = $2);

-- name: SoftDeleteUser :exec
UPDATE "UserTable"
SET metadata = jsonb_set(metadata, '{status}', '"deleted"'), updated_at = NOW(), updated_by = $2
WHERE user_id = $1;

-- name: SetUserStatus :exec
UPDATE "UserTable"
SET metadata = jsonb_set(metadata, '{status}', to_jsonb($2::text)), updated_at = NOW(), updated_by = $3
WHERE user_id = $1;
```

## Route Plan

```go
// Users
r.Get("/users", h.handleUsers)
r.Get("/users/table", h.handleUsersTable)
r.Post("/users/create", h.handleUserCreate)

// User Detail
r.Get("/users/{user_id}", h.handleUserDetail)
r.Get("/users/{user_id}/edit", h.handleUserEdit)
r.Post("/users/{user_id}/update", h.handleUserUpdate)
r.Post("/users/{user_id}/block", h.handleUserBlock)
r.Post("/users/{user_id}/unblock", h.handleUserUnblock)
r.Post("/users/{user_id}/delete", h.handleUserDelete)
```

## Implementation Phases

### Phase 1: List + Create (P1)
1. Add DB queries (ListUsersPaginated, CountUsers)
2. Run `sqlc generate`
3. Create `handler_users.go` (list, table partial, create)
4. Create `pages/users.templ` (list page, create dialog, table)
5. Add routes + sidebar nav
6. Test

### Phase 2: Detail + Edit (P1)
1. Create `handler_users_detail.go` (detail, edit, update)
2. Add detail page template in `users.templ`
3. Show teams, keys, spend on detail page
4. Test

### Phase 3: Disable/Enable/Delete (P2)
1. Add SetUserStatus, SoftDeleteUser queries
2. Add block/unblock/delete handlers
3. Add confirmation dialogs in templ
4. Test

### Phase 4: E2E Tests (P2)
1. Write E2E tests following existing pattern
2. Cover: list, create, edit, disable, delete

## Test Plan

### Unit Tests (`handler_users_test.go`)
- TestHandleUsers_ListRendersPage
- TestHandleUsersTable_Pagination
- TestHandleUsersTable_Search
- TestHandleUserCreate_Success
- TestHandleUserCreate_DuplicateEmail
- TestHandleUserDetail_ShowsInfo
- TestHandleUserUpdate_ChangesRole
- TestHandleUserBlock_ChangesStatus
- TestHandleUserDelete_SoftDeletes

### E2E Tests
- TestUsersList_ShowsUsers
- TestUserCreate_FormSubmit
- TestUserDetail_ShowsTeamsAndKeys
- TestUserEdit_FormPrefilled
- TestUserBlock_StatusChanges
- TestUserDelete_Confirmation
