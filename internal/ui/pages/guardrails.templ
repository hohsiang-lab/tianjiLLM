package pages

import (
	"fmt"
	"time"

	"github.com/praxisllmlab/tianjiLLM/internal/ui/components/badge"
	"github.com/praxisllmlab/tianjiLLM/internal/ui/components/button"
	"github.com/praxisllmlab/tianjiLLM/internal/ui/components/card"
	"github.com/praxisllmlab/tianjiLLM/internal/ui/components/dialog"
	"github.com/praxisllmlab/tianjiLLM/internal/ui/components/icon"
	"github.com/praxisllmlab/tianjiLLM/internal/ui/components/input"
	"github.com/praxisllmlab/tianjiLLM/internal/ui/components/pagination"
	"github.com/praxisllmlab/tianjiLLM/internal/ui/components/table"
	"github.com/praxisllmlab/tianjiLLM/internal/ui/components/toast"
)

// --- Data types ---

type GuardrailRow struct {
	ID            string
	Name          string
	Type          string
	FailurePolicy string
	Enabled       bool
	CreatedAt     time.Time
	ConfigJSON    string
}

type GuardrailsPageData struct {
	Guardrails []GuardrailRow
	Page       int
	TotalPages int
	TotalCount int
	PerPage    int
	Search     string
}

type GuardrailBindingPolicy struct {
	ID    string
	Name  string
	Teams []string
	Keys  []string
}

type GuardrailBindingsData struct {
	GuardrailID     string
	GuardrailName   string
	BoundPolicies   []GuardrailBindingPolicy
	UnboundPolicies []GuardrailBindingPolicy
	Error           string
}

func (d GuardrailsPageData) guardrailsFilterQueryString() string {
	if d.Search != "" {
		return "&search=" + d.Search
	}
	return ""
}

// --- Templates ---

templ guardrailEnabledBadge(enabled bool) {
	if enabled {
		@badge.Badge(badge.Props{Variant: badge.VariantSecondary}) {
			Enabled
		}
	} else {
		@badge.Badge(badge.Props{Variant: badge.VariantDestructive}) {
			Disabled
		}
	}
}

templ GuardrailsPage(data GuardrailsPageData) {
	@AppLayout("Guardrails", "/ui/guardrails") {
		@dialog.Script()
		@input.Script()
		@toast.Script()
		<div class="space-y-3">
			<div id="guardrail-filters" class="flex items-center gap-2">
				<div class="relative flex-1">
					@icon.Search(icon.Props{Size: 16, Class: "absolute left-2.5 top-1/2 -translate-y-1/2 text-muted-foreground pointer-events-none"})
					<input
						type="text"
						name="search"
						placeholder="Search by name..."
						value={ data.Search }
						class="flex h-9 w-full rounded-md border border-input bg-transparent pl-8 pr-3 py-1 text-sm shadow-xs outline-none placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]"
						hx-get="/ui/guardrails/table"
						hx-trigger="input changed delay:300ms"
						hx-target="#guardrails-table"
						hx-include="#guardrail-filters"
					/>
				</div>
				@dialog.Dialog(dialog.Props{ID: "create-guardrail-dialog"}) {
					@dialog.Trigger(dialog.TriggerProps{}) {
						@button.Button(button.Props{Size: button.SizeSm}) {
							@icon.Plus(icon.Props{Size: 16, Class: "mr-1"})
							New Guardrail
						}
					}
					@dialog.Content(dialog.ContentProps{Class: "max-w-lg"}) {
						@dialog.Header() {
							@dialog.Title() {
								Create New Guardrail
							}
							@dialog.Description() {
								Configure a guardrail to filter or moderate requests and responses.
							}
						}
						@createGuardrailForm()
					}
				}
			</div>
			<div id="guardrails-table" data-testid="guardrails-table">
				@GuardrailsTablePartial(data)
			</div>
		</div>
	}
}

templ createGuardrailForm() {
	<form
		hx-post="/ui/guardrails/create"
		hx-target="#guardrails-table"
	>
		<div class="space-y-4 py-4">
			<div class="space-y-2">
				<label for="guardrail_name" class="text-sm font-medium">Name <span class="text-destructive">*</span></label>
				@input.Input(input.Props{
					ID:          "guardrail_name",
					Name:        "guardrail_name",
					Placeholder: "my-guardrail",
					Attributes:  templ.Attributes{"required": "true"},
				})
			</div>
			<div class="space-y-2">
				<label for="guardrail_type" class="text-sm font-medium">Type <span class="text-destructive">*</span></label>
				<select name="guardrail_type" id="guardrail_type" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" required>
					<option value="">Select type...</option>
					<option value="openai_moderation">OpenAI Moderation</option>
					<option value="presidio">Presidio</option>
					<option value="prompt_injection">Prompt Injection</option>
					<option value="lakera_guard">Lakera Guard</option>
					<option value="bedrock_guardrail">Bedrock Guardrail</option>
					<option value="azure_prompt_shield">Azure Prompt Shield</option>
					<option value="azure_text_moderation">Azure Text Moderation</option>
					<option value="content_filter">Content Filter</option>
					<option value="tool_permission">Tool Permission</option>
					<option value="generic">Generic</option>
					<option value="aim">AIM</option>
					<option value="aporia">Aporia</option>
					<option value="custom_code">Custom Code</option>
					<option value="dynamoai">DynamoAI</option>
					<option value="enkryptai">EnkryptAI</option>
					<option value="grayswan">Gray Swan</option>
					<option value="guardrails_ai">Guardrails AI</option>
					<option value="hiddenlayer">HiddenLayer</option>
					<option value="ibm_guardrails">IBM Guardrails</option>
					<option value="javelin">Javelin</option>
					<option value="lakera_v2">Lakera V2</option>
					<option value="lasso">Lasso</option>
					<option value="model_armor">Model Armor</option>
					<option value="noma">Noma</option>
					<option value="onyx">Onyx</option>
					<option value="pangea">Pangea</option>
					<option value="panw_prisma_airs">PANW Prisma AIRS</option>
					<option value="pillar">Pillar</option>
					<option value="prompt_security">Prompt Security</option>
					<option value="qualifire">Qualifire</option>
					<option value="unified_guardrail">Unified Guardrail</option>
					<option value="zscaler_ai_guard">Zscaler AI Guard</option>
				</select>
			</div>
			<div class="space-y-2">
				<label for="guardrail_failure_policy" class="text-sm font-medium">Failure Policy</label>
				<select name="failure_policy" id="guardrail_failure_policy" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
					<option value="fail_open">Fail Open (allow on error)</option>
					<option value="fail_closed">Fail Closed (block on error)</option>
				</select>
			</div>
			<div class="space-y-2">
				<label for="guardrail_config" class="text-sm font-medium">Config (JSON)</label>
				<textarea
					name="config"
					id="guardrail_config"
					rows="4"
					placeholder="{}"
					class="flex w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm font-mono shadow-xs outline-none placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]"
				>{}</textarea>
			</div>
			<div class="flex items-center gap-2">
				<input type="checkbox" name="enabled" id="guardrail_enabled" class="h-4 w-4 rounded border border-input" checked/>
				<label for="guardrail_enabled" class="text-sm font-medium">Enabled</label>
			</div>
		</div>
		@dialog.Footer() {
			@dialog.Close() {
				@button.Button(button.Props{Variant: button.VariantOutline}) {
					Cancel
				}
			}
			@button.Button(button.Props{Type: "submit"}) {
				Create Guardrail
			}
		}
	</form>
}

templ GuardrailsTablePartial(data GuardrailsPageData) {
	@card.Card() {
		@card.Content(card.ContentProps{Class: "p-0"}) {
			@table.Table() {
				@table.Header() {
					@table.Row() {
						@table.Head() { Name }
						@table.Head() { Type }
						@table.Head() { Failure Policy }
						@table.Head() { Status }
						@table.Head() { Created }
						@table.Head(table.HeadProps{Class: "text-right"}) { Actions }
					}
				}
				@table.Body() {
					if len(data.Guardrails) == 0 {
						@table.Row() {
							@table.Cell(table.CellProps{Attributes: templ.Attributes{"colspan": "6"}}) {
								if data.Search != "" {
									<div class="py-8 text-center text-muted-foreground">No guardrails match your search</div>
								} else {
									<div class="py-8 text-center text-muted-foreground">
										No guardrails configured
										<br/>
										<button
											{ templ.Attributes{"onclick": `document.querySelector('[data-dialog-id="create-guardrail-dialog"] [data-dialog-trigger]').click()`}... }
											class="mt-2 inline-flex items-center rounded-md border border-input bg-background px-3 py-1.5 text-sm font-medium hover:bg-accent hover:text-accent-foreground"
										>New Guardrail</button>
									</div>
								}
							}
						}
					}
					for _, g := range data.Guardrails {
						@guardrailTableRow(g)
					}
				}
			}
		}
	}
	<div class="mt-4 flex items-center justify-between">
		<span class="text-sm text-muted-foreground">
			if data.TotalCount == 0 {
				No results
			} else {
				{ fmt.Sprintf("Showing %d–%d of %d results", (data.Page-1)*data.PerPage+1, minInt((data.Page)*data.PerPage, data.TotalCount), data.TotalCount) }
			}
		</span>
		if data.TotalPages > 1 {
			{{ pg := pagination.CreatePagination(data.Page, data.TotalPages, 5) }}
			{{ qs := data.guardrailsFilterQueryString() }}
			@pagination.Pagination() {
				@pagination.Content() {
					@pagination.Item() {
						@pagination.Previous(pagination.PreviousProps{
							Disabled: !pg.HasPrevious,
							Attributes: templ.Attributes{
								"hx-get":    fmt.Sprintf("/ui/guardrails/table?page=%d%s", data.Page-1, qs),
								"hx-target": "#guardrails-table",
							},
						})
					}
					if pg.Pages[0] > 1 {
						@pagination.Item() {
							@pagination.Link(pagination.LinkProps{
								Attributes: templ.Attributes{
									"hx-get":    fmt.Sprintf("/ui/guardrails/table?page=1%s", qs),
									"hx-target": "#guardrails-table",
								},
							}) {
								1
							}
						}
						if pg.Pages[0] > 2 {
							@pagination.Item() {
								@pagination.Ellipsis()
							}
						}
					}
					for _, p := range pg.Pages {
						@pagination.Item() {
							@pagination.Link(pagination.LinkProps{
								IsActive: p == pg.CurrentPage,
								Attributes: templ.Attributes{
									"hx-get":    fmt.Sprintf("/ui/guardrails/table?page=%d%s", p, qs),
									"hx-target": "#guardrails-table",
								},
							}) {
								{ fmt.Sprintf("%d", p) }
							}
						}
					}
					if pg.Pages[len(pg.Pages)-1] < pg.TotalPages {
						if pg.Pages[len(pg.Pages)-1] < pg.TotalPages-1 {
							@pagination.Item() {
								@pagination.Ellipsis()
							}
						}
						@pagination.Item() {
							@pagination.Link(pagination.LinkProps{
								Attributes: templ.Attributes{
									"hx-get":    fmt.Sprintf("/ui/guardrails/table?page=%d%s", pg.TotalPages, qs),
									"hx-target": "#guardrails-table",
								},
							}) {
								{ fmt.Sprintf("%d", pg.TotalPages) }
							}
						}
					}
					@pagination.Item() {
						@pagination.Next(pagination.NextProps{
							Disabled: !pg.HasNext,
							Attributes: templ.Attributes{
								"hx-get":    fmt.Sprintf("/ui/guardrails/table?page=%d%s", data.Page+1, qs),
								"hx-target": "#guardrails-table",
							},
						})
					}
				}
			}
		}
	</div>
}

templ guardrailTableRow(g GuardrailRow) {
	@table.Row() {
		@table.Cell() {
			<span class="font-medium">{ g.Name }</span>
		}
		@table.Cell() {
			<span class="text-sm font-mono text-muted-foreground">{ g.Type }</span>
		}
		@table.Cell() {
			if g.FailurePolicy == "fail_closed" {
				@badge.Badge(badge.Props{Variant: badge.VariantDestructive}) {
					fail_closed
				}
			} else {
				@badge.Badge(badge.Props{Variant: badge.VariantSecondary}) {
					fail_open
				}
			}
		}
		@table.Cell() {
			@guardrailEnabledBadge(g.Enabled)
		}
		@table.Cell() {
			<span class="text-sm text-muted-foreground">{ g.CreatedAt.Format("2006-01-02") }</span>
		}
		@table.Cell(table.CellProps{Class: "text-right"}) {
			<div class="flex items-center justify-end gap-1">
				if g.Enabled {
					<form hx-post={ "/ui/guardrails/" + g.ID + "/toggle" } hx-target="#guardrails-table" hx-swap="innerHTML">
						@button.Button(button.Props{Variant: button.VariantOutline, Size: button.SizeSm, Type: "submit"}) {
							Disable
						}
					</form>
				} else {
					<form hx-post={ "/ui/guardrails/" + g.ID + "/toggle" } hx-target="#guardrails-table" hx-swap="innerHTML">
						@button.Button(button.Props{Variant: button.VariantOutline, Size: button.SizeSm, Type: "submit"}) {
							Enable
						}
					</form>
				}
				@dialog.Dialog(dialog.Props{ID: "bindings-guardrail-" + g.ID}) {
					@dialog.Trigger(dialog.TriggerProps{}) {
						@button.Button(button.Props{Variant: button.VariantOutline, Size: button.SizeSm}) {
							@icon.Link(icon.Props{Size: 14, Class: "mr-1"})
							Bindings
						}
					}
					@dialog.Content(dialog.ContentProps{Class: "max-w-lg"}) {
						@dialog.Header() {
							@dialog.Title() {
								Policy Bindings
							}
							@dialog.Description() {
								{ "Policies using guardrail \"" + g.Name + "\"" }
							}
						}
						<div
							id={ "bindings-content-" + g.ID }
							hx-get={ "/ui/guardrails/" + g.ID + "/bindings" }
							hx-trigger="revealed"
							hx-target={ "#bindings-content-" + g.ID }
							class="min-h-[4rem]"
						>
							<p class="text-sm text-muted-foreground">Loading...</p>
						</div>
					}
				}
				@dialog.Dialog(dialog.Props{ID: "test-guardrail-" + g.ID}) {
					@dialog.Trigger(dialog.TriggerProps{}) {
						@button.Button(button.Props{Variant: button.VariantOutline, Size: button.SizeSm}) {
							@icon.FlaskConical(icon.Props{Size: 14, Class: "mr-1"})
							Test
						}
					}
					@dialog.Content(dialog.ContentProps{Class: "max-w-lg"}) {
						@dialog.Header() {
							@dialog.Title() {
								Test Guardrail
							}
							@dialog.Description() {
								{ "Test guardrail \"" + g.Name + "\" with a sample prompt" }
							}
						}
						<div class="space-y-4 py-2">
							<form
								hx-post={ "/ui/guardrails/" + g.ID + "/test" }
								hx-target={ "#test-result-" + g.ID }
								class="space-y-3"
							>
								<div class="space-y-2">
									<label class="text-sm font-medium">Test Prompt</label>
									<textarea
										name="test_text"
										rows="3"
										placeholder="Enter a test prompt to check against this guardrail..."
										class="flex w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-xs outline-none placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]"
									></textarea>
								</div>
								@button.Button(button.Props{Type: "submit", Size: button.SizeSm}) {
									@icon.FlaskConical(icon.Props{Size: 14, Class: "mr-1"})
									Run Test
								}
							</form>
							<div id={ "test-result-" + g.ID }></div>
						</div>
					}
				}
				@dialog.Dialog(dialog.Props{ID: "edit-guardrail-" + g.ID}) {
					@dialog.Trigger(dialog.TriggerProps{}) {
						@button.Button(button.Props{Variant: button.VariantOutline, Size: button.SizeSm}) {
							@icon.Pencil(icon.Props{Size: 14})
						}
					}
					@dialog.Content(dialog.ContentProps{Class: "max-w-lg"}) {
						@dialog.Header() {
							@dialog.Title() {
								Edit Guardrail
							}
						}
						@editGuardrailForm(g)
					}
				}
				@dialog.Dialog(dialog.Props{ID: "delete-guardrail-" + g.ID}) {
					@dialog.Trigger(dialog.TriggerProps{}) {
						@button.Button(button.Props{Variant: button.VariantDestructive, Size: button.SizeSm}) {
							@icon.Trash(icon.Props{Size: 14})
						}
					}
					@dialog.Content(dialog.ContentProps{Class: "max-w-sm"}) {
						@dialog.Header() {
							@dialog.Title() {
								Delete Guardrail
							}
							@dialog.Description() {
								{ "Are you sure you want to delete guardrail \"" + g.Name + "\"? This action cannot be undone." }
							}
						}
						@dialog.Footer() {
							@dialog.Close() {
								@button.Button(button.Props{Variant: button.VariantOutline}) {
									Cancel
								}
							}
							<form hx-post={ "/ui/guardrails/" + g.ID + "/delete" } hx-target="#guardrails-table" hx-swap="innerHTML">
								@button.Button(button.Props{Variant: button.VariantDestructive, Type: "submit"}) {
									Delete
								}
							</form>
						}
					}
				}
			</div>
		}
	}
}

templ editGuardrailForm(g GuardrailRow) {
	<form
		hx-post={ "/ui/guardrails/" + g.ID + "/update" }
		hx-target="#guardrails-table"
		hx-swap="innerHTML"
	>
		<div class="space-y-4 py-4">
			<div class="space-y-2">
				<label for={ "edit_name_" + g.ID } class="text-sm font-medium">Name <span class="text-destructive">*</span></label>
				@input.Input(input.Props{
					ID:         "edit_name_" + g.ID,
					Name:       "guardrail_name",
					Value:      g.Name,
					Attributes: templ.Attributes{"required": "true"},
				})
			</div>
			<div class="space-y-2">
				<label for={ "edit_type_" + g.ID } class="text-sm font-medium">Type</label>
				<select name="guardrail_type" id={ "edit_type_" + g.ID } class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
					<option value="openai_moderation" selected?={ g.Type == "openai_moderation" }>OpenAI Moderation</option>
					<option value="presidio" selected?={ g.Type == "presidio" }>Presidio</option>
					<option value="prompt_injection" selected?={ g.Type == "prompt_injection" }>Prompt Injection</option>
					<option value="lakera_guard" selected?={ g.Type == "lakera_guard" }>Lakera Guard</option>
					<option value="bedrock_guardrail" selected?={ g.Type == "bedrock_guardrail" }>Bedrock Guardrail</option>
					<option value="azure_prompt_shield" selected?={ g.Type == "azure_prompt_shield" }>Azure Prompt Shield</option>
					<option value="azure_text_moderation" selected?={ g.Type == "azure_text_moderation" }>Azure Text Moderation</option>
					<option value="content_filter" selected?={ g.Type == "content_filter" }>Content Filter</option>
					<option value="tool_permission" selected?={ g.Type == "tool_permission" }>Tool Permission</option>
					<option value="generic" selected?={ g.Type == "generic" }>Generic</option>
					<option value="aim" selected?={ g.Type == "aim" }>AIM</option>
					<option value="aporia" selected?={ g.Type == "aporia" }>Aporia</option>
					<option value="custom_code" selected?={ g.Type == "custom_code" }>Custom Code</option>
					<option value="dynamoai" selected?={ g.Type == "dynamoai" }>DynamoAI</option>
					<option value="enkryptai" selected?={ g.Type == "enkryptai" }>EnkryptAI</option>
					<option value="grayswan" selected?={ g.Type == "grayswan" }>Gray Swan</option>
					<option value="guardrails_ai" selected?={ g.Type == "guardrails_ai" }>Guardrails AI</option>
					<option value="hiddenlayer" selected?={ g.Type == "hiddenlayer" }>HiddenLayer</option>
					<option value="ibm_guardrails" selected?={ g.Type == "ibm_guardrails" }>IBM Guardrails</option>
					<option value="javelin" selected?={ g.Type == "javelin" }>Javelin</option>
					<option value="lakera_v2" selected?={ g.Type == "lakera_v2" }>Lakera V2</option>
					<option value="lasso" selected?={ g.Type == "lasso" }>Lasso</option>
					<option value="model_armor" selected?={ g.Type == "model_armor" }>Model Armor</option>
					<option value="noma" selected?={ g.Type == "noma" }>Noma</option>
					<option value="onyx" selected?={ g.Type == "onyx" }>Onyx</option>
					<option value="pangea" selected?={ g.Type == "pangea" }>Pangea</option>
					<option value="panw_prisma_airs" selected?={ g.Type == "panw_prisma_airs" }>PANW Prisma AIRS</option>
					<option value="pillar" selected?={ g.Type == "pillar" }>Pillar</option>
					<option value="prompt_security" selected?={ g.Type == "prompt_security" }>Prompt Security</option>
					<option value="qualifire" selected?={ g.Type == "qualifire" }>Qualifire</option>
					<option value="unified_guardrail" selected?={ g.Type == "unified_guardrail" }>Unified Guardrail</option>
					<option value="zscaler_ai_guard" selected?={ g.Type == "zscaler_ai_guard" }>Zscaler AI Guard</option>
				</select>
			</div>
			<div class="space-y-2">
				<label for={ "edit_policy_" + g.ID } class="text-sm font-medium">Failure Policy</label>
				<select name="failure_policy" id={ "edit_policy_" + g.ID } class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
					<option value="fail_open" selected?={ g.FailurePolicy == "fail_open" }>Fail Open (allow on error)</option>
					<option value="fail_closed" selected?={ g.FailurePolicy == "fail_closed" }>Fail Closed (block on error)</option>
				</select>
			</div>
			<div class="space-y-2">
				<label for={ "edit_config_" + g.ID } class="text-sm font-medium">Config (JSON)</label>
				<textarea
					name="config"
					id={ "edit_config_" + g.ID }
					rows="4"
					class="flex w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm font-mono shadow-xs outline-none placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]"
				>{ g.ConfigJSON }</textarea>
			</div>
			<div class="flex items-center gap-2">
				if g.Enabled {
					<input type="checkbox" name="enabled" id={ "edit_enabled_" + g.ID } class="h-4 w-4 rounded border border-input" checked/>
				} else {
					<input type="checkbox" name="enabled" id={ "edit_enabled_" + g.ID } class="h-4 w-4 rounded border border-input"/>
				}
				<label for={ "edit_enabled_" + g.ID } class="text-sm font-medium">Enabled</label>
			</div>
		</div>
		@dialog.Footer() {
			@dialog.Close() {
				@button.Button(button.Props{Variant: button.VariantOutline}) {
					Cancel
				}
			}
			@button.Button(button.Props{Type: "submit"}) {
				Save Changes
			}
		}
	</form>
}

templ GuardrailsTableWithToast(data GuardrailsPageData, toastMsg string, toastVariant toast.Variant) {
	@GuardrailsTablePartial(data)
	if toastMsg != "" {
		<div id="toast-oob" hx-swap-oob="afterbegin:body">
			@toast.Toast(toast.Props{
				Title:       toastMsg,
				Variant:     toastVariant,
				Dismissible: true,
				Duration:    3000,
			})
		</div>
	}
}

templ GuardrailBindingsPartial(data GuardrailBindingsData) {
	if data.Error != "" {
		<div class="rounded-md border border-destructive/50 bg-destructive/10 p-3 text-sm text-destructive">
			{ data.Error }
		</div>
	} else {
		<div class="space-y-4">
			if len(data.BoundPolicies) > 0 {
				<div>
					<p class="text-sm font-medium mb-2">Bound Policies</p>
					<div class="space-y-2">
						for _, p := range data.BoundPolicies {
							<div class="flex items-center justify-between rounded-md border p-3">
								<div class="text-sm">
									<span class="font-medium">{ p.Name }</span>
									if len(p.Teams) > 0 || len(p.Keys) > 0 {
										<span class="text-muted-foreground ml-2">
											{ fmt.Sprintf("%d teams · %d keys", len(p.Teams), len(p.Keys)) }
										</span>
									}
								</div>
								<form
									hx-post={ "/ui/guardrails/" + data.GuardrailID + "/bindings/remove" }
									hx-target={ "#bindings-content-" + data.GuardrailID }
								>
									<input type="hidden" name="policy_id" value={ p.ID }/>
									@button.Button(button.Props{Variant: button.VariantOutline, Size: button.SizeSm, Type: "submit"}) {
										Remove
									}
								</form>
							</div>
						}
					</div>
				</div>
			} else {
				<p class="text-sm text-muted-foreground">No policies are bound to this guardrail.</p>
			}
			if len(data.UnboundPolicies) > 0 {
				<div class="border-t pt-4">
					<p class="text-sm font-medium mb-2">Add to Policy</p>
					<form
						class="flex gap-2"
						hx-post={ "/ui/guardrails/" + data.GuardrailID + "/bindings/add" }
						hx-target={ "#bindings-content-" + data.GuardrailID }
					>
						<select name="policy_id" class="flex h-9 flex-1 rounded-md border border-input bg-background px-3 py-1 text-sm">
							for _, p := range data.UnboundPolicies {
								<option value={ p.ID }>{ p.Name }</option>
							}
						</select>
						@button.Button(button.Props{Size: button.SizeSm, Type: "submit"}) {
							Add
						}
					</form>
				</div>
			}
		</div>
	}
}

templ GuardrailTestResultPartial(done, passed bool, message, errMsg string) {
	if done {
		if errMsg != "" {
			<div class="rounded-md border border-destructive/50 bg-destructive/10 p-3 text-sm text-destructive">
				<span class="font-medium">Error:</span>
				{ " " + errMsg }
			</div>
		} else if passed {
			<div class="rounded-md border border-green-200 bg-green-50 p-3 text-sm text-green-800 dark:border-green-800 dark:bg-green-900/20 dark:text-green-400">
				@icon.ShieldCheck(icon.Props{Size: 14, Class: "inline mr-1"})
				<span class="font-medium">Passed</span>
				if message != "" {
					{ " — " + message }
				}
			</div>
		} else {
			<div class="rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-800 dark:border-red-800 dark:bg-red-900/20 dark:text-red-400">
				@icon.ShieldX(icon.Props{Size: 14, Class: "inline mr-1"})
				<span class="font-medium">Blocked</span>
				if message != "" {
					{ " — " + message }
				}
			</div>
		}
	}
}
